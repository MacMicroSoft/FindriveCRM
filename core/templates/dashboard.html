{% extends 'index.html' %}
{% load static %}

{% block title %}Автопарк{% endblock %}

{% block head %}
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h1 style="color: #111827; font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Автопарк
        </h1>
        <button type="button" id="openModalBtn" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
            <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="hidden-mobile">Додати авто</span>
        </button>
    </div>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;" id="tabsContainer">
        <button class="tab-btn active" data-tab="active" style="flex: 1; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s;">
            Активні (<span id="activeCount">{{ cars_active|length }}</span>)
        </button>
        <button class="tab-btn" data-tab="pending" style="flex: 1; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s;">
            Очікуючі (<span id="pendingCount">{{ cars_pending|length }}</span>)
        </button>
    </div>
    <div style="position: relative;">
        <svg style="width: 1.25rem; height: 1.25rem; position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="carSearch" placeholder="Пошук за номером, маркою, VIN..." style="width: 100%; padding: 0.5rem 0.75rem 0.5rem 2.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='#2563eb'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)'" onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'">
    </div>
    
    <style>
        .hidden-mobile { display: inline; }
        @media (max-width: 767px) {
            .hidden-mobile { display: none; }
        }
        .tab-btn {
            background: #f3f4f6;
            color: #374151;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-btn:hover:not(.active) {
            background: #e5e7eb;
        }
    </style>
{% endblock %}

{% block content %}
    <style>
        .vehicle-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .vehicle-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .icon {
            width: 1rem;
            height: 1rem;
            display: inline-block;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
        }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-await { background: #fef3c7; color: #964310; }
        .tab-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            border: none;
            background: #f3f4f6;
            color: #374151;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-btn:hover:not(.active) {
            background: #e5e7eb;
        }
        @media (max-width: 640px) {
            .vehicle-card {
                padding: 0.875rem !important;
            }
            .tab-btn {
                font-size: 0.8125rem !important;
                padding: 0.5rem 0.75rem !important;
            }
        }
        @media (max-width: 480px) {
            .vehicle-card {
                padding: 0.75rem !important;
            }
            .status-badge {
                font-size: 0.6875rem !important;
                padding: 0.1875rem 0.375rem !important;
            }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>

    <div>
        <!-- Активні авто -->
        <div id="activeTab" class="tab-content active">
            {% if cars_active %}
                <div id="activeVehiclesList">
                    {% for car in cars_active %}
                        <div class="vehicle-card" 
                             data-search="{{ car.mark }} {{ car.model }} {{ car.license_plate }} {{ car.vin_code }}"
                             data-car-id="{{ car.pk }}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span style="color: #111827; font-weight: 500;">{{ car.mark }} {{ car.model }}</span>
                                        <span class="status-badge status-{{ car.status|lower }}">
                                            {% if car.status == "Active" %}Активне авто
                                            {% elif car.status == "Await" %}Очікуюче авто
                                            {% else %}{{ car.get_status_display|default:car.status }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p style="color: #4b5563;">{{ car.license_plate }}</p>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #6b7280; font-size: 0.875rem;">{{ car.year }}</span>
                                    <div style="display: flex; gap: 0.25rem;">
                                        <button onclick="event.stopPropagation(); openEditCarModal('{{ car.pk }}')" 
                                                style="background: #2563eb; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
                                                title="Редагувати">
                                            <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="event.stopPropagation(); openDeleteCarModal('{{ car.pk }}', '{{ car.mark }} {{ car.model }} {{ car.year }}')" 
                                                style="background: #dc2626; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
                                                title="Видалити">
                                            <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem;">
                                <span style="color: #6b7280;">VIN: {{ car.vin_code }}</span>
                            </div>

                            {% if car.owner %}
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #f3f4f6;">
                                    <p style="font-size: 0.875rem; color: #4b5563;">
                                        Власник: <span style="color: #111827;">{{ car.owner.first_name }} {{ car.owner.last_name }}</span>
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 3rem 0; color: #6b7280;">
                    <svg style="width: 3rem; height: 3rem; margin: 0 auto 0.75rem; opacity: 0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>Немає активних автомобілів</p>
                </div>
            {% endif %}
        </div>

        <!-- Очікуючі авто -->
        <div id="pendingTab" class="tab-content">
            {% if cars_pending %}
                <div id="pendingVehiclesList">
                    {% for car in cars_pending %}
                        <div class="vehicle-card" 
                             data-search="{{ car.mark }} {{ car.model }} {{ car.license_plate }} {{ car.vin_code }}"
                             data-car-id="{{ car.pk }}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span style="color: #111827; font-weight: 500;">{{ car.mark }} {{ car.model }}</span>
                                        <span class="status-badge status-{{ car.status|lower }}">
                                            {% if car.status == "Active" %}Активне авто
                                            {% elif car.status == "Await" %}Очікуюче авто
                                            {% else %}{{ car.get_status_display|default:car.status }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p style="color: #4b5563;">{{ car.license_plate }}</p>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #6b7280; font-size: 0.875rem;">{{ car.year }}</span>
                                    <div style="display: flex; gap: 0.25rem;">
                                        <button onclick="event.stopPropagation(); openEditCarModal('{{ car.pk }}')" 
                                                style="background: #2563eb; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
                                                title="Редагувати">
                                            <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="event.stopPropagation(); openDeleteCarModal('{{ car.pk }}', '{{ car.mark }} {{ car.model }} {{ car.year }}')" 
                                                style="background: #dc2626; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
                                                title="Видалити">
                                            <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem;">
                                <span style="color: #6b7280;">VIN: {{ car.vin_code }}</span>
                            </div>

                            {% if car.owner %}
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #f3f4f6;">
                                    <p style="font-size: 0.875rem; color: #4b5563;">
                                        Власник: <span style="color: #111827;">{{ car.owner.first_name }} {{ car.owner.last_name }}</span>
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 3rem 0; color: #6b7280;">
                    <svg style="width: 3rem; height: 3rem; margin: 0 auto 0.75rem; opacity: 0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>Немає очікуючих автомобілів</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% include 'components/add_car_form.html' %}
    {% include 'components/edit_car_form.html' %}
    {% include 'components/delete_car_modal.html' %}

    <script>
        // Vehicle card click handler - використовуємо делегування подій для надійної роботи
        (function() {
            // Зберігаємо посилання на обробник для можливості видалення
            let handleCardClick = function(e) {
                // Перевірити, чи клік не на кнопці Edit/Delete
                if (e.target.closest('button') || e.target.closest('a')) {
                    return;
                }
                
                // Знайти найближчу картку
                const card = e.target.closest('.vehicle-card');
                if (card) {
                    const carId = card.getAttribute('data-car-id');
                    if (carId) {
                        window.location.href = `/core/cars/${carId}/`;
                    }
                }
            };
            
            // Додати обробники при завантаженні сторінки
            function setupHandlers() {
                const activeList = document.getElementById('activeVehiclesList');
                const pendingList = document.getElementById('pendingVehiclesList');
                
                // Видалити старі обробники (якщо є) та додати нові
                if (activeList) {
                    activeList.removeEventListener('click', handleCardClick);
                    activeList.addEventListener('click', handleCardClick);
                }
                if (pendingList) {
                    pendingList.removeEventListener('click', handleCardClick);
                    pendingList.addEventListener('click', handleCardClick);
                }
            }
            
            // Ініціалізувати при завантаженні сторінки
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupHandlers);
            } else {
                setupHandlers();
            }
            
            // Перевстановити обробники при поверненні на сторінку (back/forward navigation)
            window.addEventListener('pageshow', function(event) {
                // Перевстановити обробники після повернення на сторінку
                setTimeout(setupHandlers, 0);
            });
        })();

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tab + 'Tab').classList.add('active');
            });
        });

        // Search functionality
        document.getElementById('carSearch')?.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
            const cards = document.querySelectorAll(`#${activeTab}Tab .vehicle-card`);
            
            cards.forEach(card => {
                const searchText = card.getAttribute('data-search').toLowerCase();
                if (searchText.includes(query)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Функції для відкриття модальних вікон (якщо вони не визначені в компонентах)
        if (typeof openEditCarModal === 'undefined') {
            window.openEditCarModal = function(carId) {
                // Завантажити дані автомобіля через detail view
                fetch(`/core/cars/${carId}/`)
                    .then(response => response.text())
                    .then(html => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const formInDetail = tempDiv.querySelector('#carDetailForm');
                        const editModal = document.getElementById("editCarModal");
                        const editForm = document.getElementById("editCarForm");
                        
                        if (formInDetail && editForm) {
                            editForm.action = `/core/cars/update/${carId}/`;
                            
                            // Оновити поля форми
                            const inputs = formInDetail.querySelectorAll('input, select, textarea');
                            inputs.forEach(input => {
                                const name = input.getAttribute('name');
                                if (name && name !== 'csrfmiddlewaretoken') {
                                    const existingInput = editForm.querySelector(`[name="${name}"]`);
                                    if (existingInput) {
                                        if (input.type === 'checkbox') {
                                            existingInput.checked = input.checked;
                                        } else if (name === 'owner') {
                                            // Для select owner потрібно скопіювати опції
                                            const ownerSelect = editForm.querySelector('select[name="owner"]');
                                            if (ownerSelect) {
                                                ownerSelect.innerHTML = '';
                                                Array.from(input.options).forEach(option => {
                                                    const newOption = option.cloneNode(true);
                                                    ownerSelect.appendChild(newOption);
                                                });
                                                ownerSelect.value = input.value;
                                            }
                                        } else {
                                            existingInput.value = input.value;
                                        }
                                    }
                                }
                            });
                        }
                        if (editModal) {
                            editModal.style.display = "flex";
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        const editModal = document.getElementById("editCarModal");
                        const editForm = document.getElementById("editCarForm");
                        if (editForm) {
                            editForm.action = `/core/cars/update/${carId}/`;
                        }
                        if (editModal) {
                            editModal.style.display = "flex";
                        }
                    });
            };
        }

        if (typeof openDeleteCarModal === 'undefined') {
            window.openDeleteCarModal = function(carId, carName) {
                const deleteModal = document.getElementById("deleteCarModal");
                const deleteForm = document.getElementById("deleteCarForm");
                const deleteName = document.getElementById("deleteCarName");
                
                if (deleteName) {
                    deleteName.textContent = carName;
                }
                if (deleteForm) {
                    deleteForm.action = `/core/cars/delete/${carId}/`;
                }
                if (deleteModal) {
                    deleteModal.style.display = "flex";
                }
            };
        }
    </script>
{% endblock %}
