{% extends 'index.html' %}
{% load static %}

{% block title %}Чати{% endblock %}

{% block head %}
<div class="chat_info">
    <h2>Чат з {{ chat.user_first }} {% if chat.user_last %}{{chat.user_last}}{% endif %}</h2>
    <p class="chat-sub">Telegram ID: {{ chat.tg_chat_id }}</p>
</div>
{% endblock %}

{% block content %}
<div class="chat-detail-page">
  <div class="chat-messages" id="chat-log">
    {% for message in chat.messages %}
      {% if message.sender == 'Telegram' %}
        <div class="message from-tg" value="{{message.tg_message_id}}">
          <div class="bubble">
            {{ message.text }}
            <span class="time">{{ message.created_at|date:"d/m/Y, H:i" }}</span>
          </div>
        </div>
      {% else %}
        <div class="message from-web" value="{{message.tg_message_id}}">
          <div class="bubble">
            {{ message.message }}
            <span class="time">{{ message.created_at|date:"d/m/Y, H:i" }}</span>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="chat-input">
    <input id="chat-message-input" type="text" placeholder="Повідомлення...">
    <button id="chat-message-submit" type="button">➤</button>
  </div>
</div>

<script>
    const chatId = "{{ chat.tg_chat_id }}";
    const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/" + chatId + "/"
    );
    // receive data
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        const chatLog = document.querySelector('#chat-log');
        if (!chatLog) return;

        let text = '';
        let messageId = '';
        let createdAt = '';
        let cssClass = '';

        if (data.sender === "telegram") {
            text = data.message.message;   
            createdAt = data.message.created_at;
            cssClass = 'from-tg';
        } else {
            text = data.message.message;
            createdAt = data.message.created_at;
            cssClass = 'from-web';
        }

        // формат часу
       const time = createdAt
        ? new Date(createdAt).toLocaleString([], {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        })
        : '';
        // створюємо DOM
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', cssClass);
        if (messageId) msgDiv.setAttribute('value', messageId);

        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        bubble.textContent = text;

        const timeSpan = document.createElement('span');
        timeSpan.classList.add('time');
        timeSpan.textContent = time;

        bubble.appendChild(timeSpan);
        msgDiv.appendChild(bubble);
        chatLog.appendChild(msgDiv);

        chatLog.scrollTop = chatLog.scrollHeight;
    };

    // Close socket connection
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.key === 'Enter') {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        // Send data to socket
        chatSocket.send(JSON.stringify({
            'message': message,
            'sender': 'web',
            'chat_id': chatId,
        }));
        messageInputDom.value = '';
    };
</script>
<style>
.chat-detail-page{
    margin: 0 auto;
    border: 1px solid #2e2e2e;
    border-radius: 12px;
    padding: 6px;
}
/* Messages */
.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  background: #eef1f5;
}

.message {
  display: flex;
}
.message.from-web {
  justify-content: flex-end;
}
.message.from-tg {
  justify-content: flex-start;
}

.bubble {
  max-width: 65%;
  padding: 10px 14px;
  border-radius: 14px;
  background: #fff;
  position: relative;
}
.from-web .bubble {
  background: #d6e4ff;
}

.time {
  display: block;
  font-size: 11px;
  color: #777;
  margin-top: 4px;
  text-align: right;
}

/* Input */
.chat-input {
  display: flex;
  padding: 12px;
  background: #fff;
  border-top: 1px solid #e0e0e0;
  gap: 8px;
}
.chat-input input {
  flex: 1;
  padding: 10px 12px;
  border-radius: 20px;
  border: 1px solid #ddd;
  outline: none;
  width: 100%;
}
.chat-input button {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 50%;
  background: #4f7cff;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}
</style>
{% endblock %}